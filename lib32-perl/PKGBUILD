# $Id$
# Maintainer: Florian Pritz <bluewind@xinu.at>
# Contributor: Angel Velasquez <angvp@archlinux.org>
# Contributor: kevin <kevin.archlinux.org>
# Contributor: judd <jvinet.zeroflux.org>
# Contributor: francois <francois.archlinux.org>

pkgname=lib32-perl
pkgver=5.20.0
pkgrel=5
pkgdesc="A highly capable, feature-rich programming language (32bit)"
arch=(i686 x86_64)
license=('GPL' 'PerlArtistic')
url="http://www.perl.org"
groups=('base')
depends=('lib32-gdbm' 'db' 'lib32-glibc' ) # 'lib32-networkmanager')
# NOTE: This array is automatically generated by `./patchprov`.
#       If you want to add entries, do so in the next array.
provides=('lib32-perl-archive-tar=1.96'
          'lib32-perl-attribute-handlers=0.96'
          'lib32-perl-autodie=2.23'
          'lib32-perl-autoloader=5.74'
          'lib32-perl-autouse=1.08'
          'lib32-perl-b-debug=1.19'
          'lib32-perl-base=2.22'
          'lib32-perl-bignum=0.37'
          'lib32-perl-carp=1.3301'
          'lib32-perl-cgi=3.65'
          'lib32-perl-compress-raw-bzip2=2.064'
          'lib32-perl-compress-raw-zlib=2.065'
          'lib32-perl-config-perl-v=0.20'
          'lib32-perl-constant=1.31'
          'lib32-perl-cpan-meta-requirements=2.125'
          'lib32-perl-cpan-meta-yaml=0.012'
          'lib32-perl-cpan-meta=2.140640'
          'lib32-perl-cpan=2.05'
          'lib32-perl-data-dumper=2.151'
          'lib32-perl-db_file=1.831'
          'lib32-perl-devel-ppport=3.21'
          'lib32-perl-devel-selfstubber=1.05'
          'lib32-perl-digest-md5=2.53'
          'lib32-perl-digest-sha=5.88'
          'lib32-perl-digest=1.17'
          'lib32-perl-dumpvalue=1.17'
          'lib32-perl-encode=2.60'
          'lib32-perl-encoding-warnings=0.11'
          'lib32-perl-env=1.04'
          'lib32-perl-experimental=0.007'
          'lib32-perl-exporter=5.70'
          'lib32-perl-extutils-cbuilder=0.280216'
          'lib32-perl-extutils-command=1.18'
          'lib32-perl-extutils-constant=0.23'
          'lib32-perl-extutils-install=1.67'
          'lib32-perl-extutils-makemaker=6.98'
          'lib32-perl-extutils-manifest=1.63'
          'lib32-perl-extutils-parsexs=3.24'
          'lib32-perl-file-fetch=0.48'
          'lib32-perl-file-path=2.09'
          'lib32-perl-file-temp=0.2304'
          'lib32-perl-filter-simple=0.91'
          'lib32-perl-filter-util-call=1.49'
          'lib32-perl-getopt-long=2.42'
          'lib32-perl-http-tiny=0.043'
          'lib32-perl-i18n-collate=1.02'
          'lib32-perl-i18n-langtags=0.40'
          'lib32-perl-if=0.0603'
          'lib32-perl-io-compress=2.064'
          'lib32-perl-io-socket-ip=0.29'
          'lib32-perl-io-zlib=1.10'
          'lib32-perl-io=1.31'
          'lib32-perl-ipc-cmd=0.92'
          'lib32-perl-ipc-sysv=2.04'
          'lib32-perl-json-pp=2.27203'
          'lib32-perl-lib=0.63'
          'lib32-perl-libnet=1.25'
          'lib32-perl-locale-codes=3.30'
          'lib32-perl-locale-maketext-simple=0.21'
          'lib32-perl-locale-maketext=1.25'
          'lib32-perl-math-bigint-fastcalc=0.31'
          'lib32-perl-math-bigint=1.9993'
          'lib32-perl-math-bigrat=0.2606'
          'lib32-perl-math-complex=1.59'
          'lib32-perl-memoize=1.03'
          'lib32-perl-mime-base64=3.14'
          'lib32-perl-module-build=0.4205'
          'lib32-perl-module-corelist=3.11'
          'lib32-perl-module-load-conditional=0.62'
          'lib32-perl-module-load=0.32'
          'lib32-perl-module-loaded=0.08'
          'lib32-perl-module-metadata=1.000019'
          'lib32-perl-net-ping=2.43'
          'lib32-perl-package-constants=0.04'
          'lib32-perl-params-check=0.38'
          'lib32-perl-parent=0.228'
          'lib32-perl-parse-cpan-meta=1.4414'
          'lib32-perl-pathtools=3.47'
          'lib32-perl-perl-ostype=1.007'
          'lib32-perl-perlfaq=5.0150044'
          'lib32-perl-perlio-via-quotedprint=0.07'
          'lib32-perl-pod-checker=1.60'
          'lib32-perl-pod-escapes=1.06'
          'lib32-perl-pod-parser=1.62'
          'lib32-perl-pod-perldoc=3.23'
          'lib32-perl-pod-simple=3.28'
          'lib32-perl-pod-usage=1.63'
          'lib32-perl-podlators=2.5.3'
          'lib32-perl-safe=2.37'
          'lib32-perl-scalar-list-utils=1.38'
          'lib32-perl-search-dict=1.07'
          'lib32-perl-selfloader=1.21'
          'lib32-perl-socket=2.013'
          'lib32-perl-storable=2.49'
          'lib32-perl-sys-syslog=0.33'
          'lib32-perl-term-ansicolor=4.02'
          'lib32-perl-term-cap=1.15'
          'lib32-perl-term-complete=1.402'
          'lib32-perl-term-readline=1.14'
          'lib32-perl-test-harness=3.30'
          'lib32-perl-test-simple=1.001002'
          'lib32-perl-test=1.26'
          'lib32-perl-text-abbrev=1.02'
          'lib32-perl-text-balanced=2.02'
          'lib32-perl-text-parsewords=3.29'
          'lib32-perl-text-tabs=2013.0523'
          'lib32-perl-thread-queue=3.05'
          'lib32-perl-thread-semaphore=2.12'
          'lib32-perl-threads-shared=1.46'
          'lib32-perl-threads=1.93'
          'lib32-perl-tie-file=1.00'
          'lib32-perl-tie-refhash=1.39'
          'lib32-perl-time-hires=1.9726'
          'lib32-perl-time-local=1.2300'
          'lib32-perl-time-piece=1.27'
          'lib32-perl-unicode-collate=1.04'
          'lib32-perl-unicode-normalize=1.17'
          'lib32-perl-version=0.9908'
          'lib32-perl-xsloader=0.17')
# Add your own provides here
provides=(${provides[@]})
source=(http://www.cpan.org/src/5.0/perl-${pkgver}.tar.bz2
        perl-vutil-revert.patch
        perlbin.sh
        perlbin.csh
        skip-lnm.patch)
options=('makeflags' '!purge')
sha512sums=('792f15800038ecd678f4a8cf8b9f329259ca46e3da2b18b94c97d1ab3b43efdf07b29975d4ffe83c38ca81bca672307dd6e6e60a22eb3ae957c8aab34b835ad9'
            'd62573394eb9253f376dc2dfb4be00a8fa675751ccdababc63198236f5bb56ca9ae78232e70f8dd8f6e31458d6c683099223ecd63804897ac6634b84ab55b6b7'
            '60b22c652331b3c617af9b9ffa3cf10b8048af814be7ead291401b4d7ac303070c908a1d80a525a561c9d6c2375c1e0d416316224880708f0c45b2509d60d32f'
            '08940eed1d99a3e35d1b62d9ac584100b0cd93889414a9fb3282e4a1caf4493223b7fcc757f2c44af2f879982a415aaf60f7c54438b757623578ee05e7e58e41'
            '6baf7d456feab6a253564caa034f31316981c2598d4001bbcf4fac29899089bef5cd91493a3458e72f915b8b2df6584636334a5173688b46c73fa86d15332632')

prepare() {
  cd ${srcdir}/perl-${pkgver}
  patch -p1 -i "$srcdir/perl-vutil-revert.patch"
  sed -i 's#version vutil.c .*#version vutil.c f1c7e4778fcf78c04141f562b80183b91cbbf6c9#' t/porting/customized.dat
  #Avoid an impossible dependency loop if lib32-networkmanager is not installed
  #patch -Np2 < ../skip-lnm.patch
}

build() {
  cd ${srcdir}/perl-${pkgver}

  export CC='gcc -m32'
  export CXX='g++ -m32'
  export LDFLAGS+=" -m32"
  export PKG_CONFIG_PATH='/usr/lib32/pkgconfig'

  ./Configure -des -Dusethreads -Duseshrplib -Doptimize="${CFLAGS}" \
    -Dprefix=/usr -Dvendorprefix=/usr \
    -Dlibdir=/usr/lib32 -Dvendorlibdir=/usr/lib32 \
    -Dlibexecdir=/usr/lib32 -Dvendorlibexecdir=/usr/lib32 \
    -Dprivlib=/usr/share/perl5/core_perl \
    -Darchlib=/usr/lib32/perl5/core_perl \
    -Dsitelib=/usr/share/perl5/site_perl \
    -Dsitearch=/usr/lib32/perl5/site_perl \
    -Dvendorlib=/usr/share/perl5/vendor_perl \
    -Dvendorarch=/usr/lib32/perl5/vendor_perl \
    -Dscriptdir=/usr/bin/core_perl \
    -Dsitescript=/usr/bin/site_perl \
    -Dvendorscript=/usr/bin/vendor_perl \
    -Dinc_version_list=none \
    -Dman1ext=1perl -Dman3ext=3perl ${arch_opts} \
    -Dlddlflags="-shared ${LDFLAGS}" -Dldflags="${LDFLAGS}" \
    -Dlibpth=/usr/lib32 -Acxxflags="-m32" -Accflags="-m32" -Aldflags="-m32 " #-Dexe_ext='-32'
  make
}

#check() {
#  cd ${srcdir}/perl-${pkgver}
#  TEST_JOBS=$(echo $MAKEFLAGS | sed 's/.*-j\([0-9][0-9]*\).*/\1/') make test_harness
#  make test
#}

package() {
  cd ${srcdir}/perl-${pkgver}
  make DESTDIR="$pkgdir" install

  ### Perl Settings ###
  # Change man page extensions for site and vendor module builds.
  # Set no mail address since bug reports should go to the bug tracker
  # and not someone's email.
  sed -e '/^man1ext=/ s/1perl/1p/' -e '/^man3ext=/ s/3perl/3pm/' \
      -e "/^cf_email=/ s/'.*'/''/" \
      -e "/^perladmin=/ s/'.*'/''/" \
      -i ${pkgdir}/usr/lib32/perl5/core_perl/Config_heavy.pl

  ### CPAN Settings ###
  # Set CPAN default config to use the site directories.
  sed -e '/(makepl_arg =>/   s/""/"INSTALLDIRS=site"/' \
      -e '/(mbuildpl_arg =>/ s/""/"installdirs=site"/' \
      -i ${pkgdir}/usr/share/perl5/core_perl/CPAN/FirstTime.pm

  # Profile script to set paths to perl scripts.
  install -D -m755 ${srcdir}/perlbin.sh \
                   ${pkgdir}/etc/profile.d/perlbin.sh
  # Profile script to set paths to perl scripts on csh. (FS#22441)
  install -D -m755 ${srcdir}/perlbin.csh \
                  ${pkgdir}/etc/profile.d/perlbin.csh

  (cd ${pkgdir}/usr/bin; mv perl${pkgver} perl)
  (cd ${pkgdir}/usr/bin/core_perl;  ln -sf c2ph pstruct; ln -sf s2p psed)

  # Remove all pod files *except* those under /usr/share/perl5/core_perl/pod/
  # (FS#16488)
  rm -f $pkgdir/usr/share/perl5/core_perl/*.pod
  for d in $pkgdir/usr/share/perl5/core_perl/*; do
    if [ -d $d -a $(basename $d) != "pod" ]; then
      find $d -name *.pod -delete
    fi
  done
  find $pkgdir/usr/lib32 -name *.pod -delete
  find $pkgdir -name .packlist -delete

  rm -rf "${pkgdir}"/{etc,usr/{share,include}} # needs bin/

  cd "${pkgdir}"/usr/bin
  rm -rf core_perl
  mv perl perl-32
  find "$pkgdir/usr/bin" -type f -not -name perl-32 -delete
  
}

